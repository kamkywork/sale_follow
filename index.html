<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î - Collection System (V.Final Complete)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* CSS Style V.75 - Fixed User Management */
        :root { 
            --primary: #4361ee;   --secondary: #3f37c9; --success: #0abde3;   
            --warning: #8e44ad;   --danger: #e71d36;    --dark: #2b2d42;      
            --light: #f8f9fa; --gray: #8d99ae; --bg: #edf2f4; --card-radius: 16px; 
        }
        
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--dark); -webkit-font-smoothing: antialiased; }
        .header { background: #ffffff; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header h2 { margin: 0; font-size: 20px; font-weight: 700; color: #4361ee; display: flex; align-items: center; gap: 8px; }
        .tools-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; align-items: center; flex-wrap: wrap; }
        .date-input, .search-input { border: 1px solid #e0e0e0; background: #f9f9f9; padding: 8px 12px; border-radius: 10px; font-family: 'Sarabun'; }
        .date-input { min-width: 130px; }
        .search-box-group { display: flex; align-items: center; background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 10px; padding-right: 5px; }
        .search-input { width: 120px; border: none; background: transparent; transition: width 0.3s; }
        .search-input:focus { width: 160px; outline: none; }
        .btn-search-icon { color: var(--primary); cursor: pointer; padding: 5px; }
        
        .btn-icon, .btn-pill { border: none; border-radius: 10px; cursor: pointer; transition: 0.2s; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-icon { width: 38px; height: 38px; flex-shrink: 0; }
        .btn-pill { padding: 8px 15px; font-size: 13px; font-weight: 600; gap: 5px; border-radius: 20px; white-space: nowrap; }
        
        .btn-refresh { background: var(--warning); }
        .btn-print { background: #341f97; }
        .btn-excel { background: #00d2d3; }
        .btn-reset { background: var(--gray); }
        .btn-daily { background: linear-gradient(135deg, #ff6b6b, #ee5253); }
        .btn-monthly { background: linear-gradient(135deg, #54a0ff, #5f27cd); }
        .btn-closed { background: #0abde3; }
        .btn-expense { background: linear-gradient(135deg, #f39c12, #d35400); }
        .btn-logout { background: #e74c3c; width: auto; padding: 0 12px; font-size: 12px; height: 38px; }
        
        .perf-container { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: white; border-radius: var(--card-radius); padding: 25px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .stat-header { display: flex; align-items: center; margin-bottom: 10px; font-weight: 600; color: var(--gray); gap: 10px; }
        .stat-header i { font-size: 1.5rem; }
        .stat-body { text-align: center; padding: 10px 0; }
        .big-number { font-size: 42px; font-weight: 800; margin: 0; line-height: 1; letter-spacing: -1px; }
        .unit-text { font-size: 14px; color: var(--gray); font-weight: normal; margin-top: 5px; display: block; }

        .list-container { padding: 0 20px 80px 20px; max-width: 800px; margin: 0 auto; }
        .polygon-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; margin-top: 10px; }
        .polygon-card { 
            padding: 20px; border-radius: 16px; color: white; cursor: pointer; transition: all 0.2s; 
            text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex;
            flex-direction: column; justify-content: center; align-items: center; min-height: 100px;
            position: relative; overflow: hidden;
        }
        .polygon-card:active { transform: scale(0.95); }
        .poly-bg-pending { background: linear-gradient(135deg, #0abde3, #48dbfb); }
        .poly-bg-normal { background: linear-gradient(135deg, #3f37c9, #4361ee); }
        .poly-bg-postpone { background: linear-gradient(135deg, #8e44ad, #9b59b6); }
        .poly-bg-overdue { background: linear-gradient(135deg, #c0392b, #e74c3c); }
        .poly-count { font-size: 36px; font-weight: 800; line-height: 1; margin-bottom: 5px; }
        .poly-title { font-size: 14px; font-weight: 600; }
        .poly-icon { font-size: 24px; margin-bottom: 5px; opacity: 0.8; }

        .cust-card { border-radius: var(--card-radius); margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; background: white; border-left: 5px solid #ddd; transition: 0.2s; animation: slideDown 0.3s ease-out; }
        .card-postpone { background: #fbf5ff; border-left-color: #9b59b6; } 
        .card-overdue { background: #fff0f0; border-left-color: #e74c3c; } 
        .card-pending-approve { background: #fffdf5; border-left-color: #48dbfb; }
        .card-search-result { border-left-color: #4361ee; background: #f0f4ff; }
        
        .cust-header { padding: 15px 15px 5px 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .cust-info h3 { margin: 0 0 4px 0; font-size: 17px; color: var(--dark); }
        .cust-id { font-size: 11px; color: var(--gray); background: rgba(0,0,0,0.03); padding: 3px 8px; border-radius: 6px; display: inline-block; border: 1px solid rgba(0,0,0,0.05); }
        
        .status-text { font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .text-green { color: #0abde3; } .text-orange { color: #8e44ad; cursor: pointer; text-decoration: underline; }
        .text-purple { color: #8e44ad; } .text-red { color: #c0392b; }
        
        .btn-kebab { border: none; background: transparent; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--gray); }
        .cust-body { padding: 0 15px 15px 15px; display: flex; justify-content: space-between; align-items: flex-end; }
        .contact-line { font-size: 13px; color: #555; display: flex; align-items: center; gap: 6px; margin-top: 5px; }
        .amount-val { font-size: 22px; font-weight: 800; color: var(--dark); letter-spacing: -0.5px; }
        .cust-actions { padding: 10px 15px; background: rgba(255,255,255,0.5); border-top: 1px solid rgba(0,0,0,0.05); display: grid; gap: 10px; border-bottom-left-radius: var(--card-radius); border-bottom-right-radius: var(--card-radius); }
        
        .btn-act, .user-checkbox-btn { border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; height: 42px; width: 100%; box-sizing: border-box; background: white; border: 1px solid #e0e0e0; color: #555; }
        .btn-act-call { color: var(--secondary); } 
        .btn-act-contract { background: #34495e; color: white; border:none; } 
        .btn-act-info { background: #0abde3; color: white; border:none; } 
        .btn-act-pay { background: #5f27cd; color: white; border:none; } 
        .btn-act-postpone { color: #7e22ce; } 
        .btn-disabled { background: #f1f1f1 !important; color: #ccc !important; border: 1px solid #eee !important; cursor: not-allowed !important; }
        
        .grid-admin-actions { grid-template-columns: 1fr 1fr 1fr 1fr; } .grid-user-actions { grid-template-columns: 1fr 1fr 1fr 1fr; } 
        .grid-closed-actions { grid-template-columns: 1fr 1fr; }
        @media (max-width: 600px) { .perf-container { grid-template-columns: 1fr; } .grid-admin-actions { grid-template-columns: 1fr 1fr; } .grid-user-actions { grid-template-columns: 1fr 1fr; } }
        
        .login-overlay { position: fixed; top: 0; left: 100%; width: 100%; height: 100%; background: rgba(43, 45, 66, 0.98); z-index: 9000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px 40px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .user-profile-badge { font-size: 11px; background: #eef3ff; color: var(--primary); padding: 3px 8px; border-radius: 15px; margin-left: 8px; cursor: pointer; display:inline-flex; align-items:center; gap:5px; }
        .loading-state { text-align: center; padding: 40px; color: var(--gray); }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }
        .swal2-file-input { font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="loginOverlay" class="login-overlay" style="left:0;">
        <div class="login-box">
            <h2 style="color:var(--dark); margin-bottom:20px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <input type="text" id="loginUser" class="date-input" style="width:100%; margin-bottom:15px; box-sizing:border-box;" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
            <input type="password" id="loginPass" class="date-input" style="width:100%; margin-bottom:15px; box-sizing:border-box;" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" onkeyup="if(event.key==='Enter') doLogin()">
            <button class="btn-pill" style="background:var(--primary); width:100%; justify-content:center; padding:12px; font-size:16px;" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            <div id="loginMsg" style="color:red; margin-top:15px; font-size:13px; min-height:20px;"></div>
        </div>
    </div>

    <div class="header">
        <div class="header-top">
            <h2 id="appTitle"><i class="fas fa-chart-pie"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î</h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <span id="currentTime" style="font-size:12px; color:var(--gray);"></span>
                <button id="btnLogout" class="btn-icon btn-logout" onclick="doLogout()" style="display:none;"><i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å</button>
            </div>
        </div>
        <div class="tools-bar">
            <div class="search-box-group">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤..." onkeyup="if(event.key==='Enter') doGlobalSearch()">
                <i class="fas fa-search btn-search-icon" onclick="doGlobalSearch()"></i>
            </div>
            
            <input type="date" id="filterDate" class="date-input" onchange="loadData()">
            <button class="btn-icon btn-refresh" onclick="loadData()"><i class="fas fa-sync-alt"></i></button>
            
            <button class="btn-pill" style="background: linear-gradient(135deg, #1e3c72, #2a5298);" onclick="showAllContracts()"><i class="fas fa-list"></i> ‡∏î‡∏π‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            
            <button class="btn-pill btn-closed" onclick="showClosedContracts()"><i class="fas fa-check-double"></i> ‡∏õ‡∏¥‡∏î/‡∏Ñ‡∏£‡∏ö‡∏á‡∏ß‡∏î</button>
            <button id="btnExpense" class="btn-pill btn-expense" style="display:none;" onclick="recordExpense()"><i class="fas fa-file-invoice-dollar"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
			<button id="btnShopReport" class="btn-pill" style="background: linear-gradient(135deg, #11998e, #38ef7d); display:none;" onclick="showShopTransferReport()">
				<i class="fas fa-money-bill-wave"></i> ‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏£‡πâ‡∏≤‡∏ô
			</button>
            <button id="btnPrint" class="btn-icon btn-print" onclick="printReport()"><i class="fas fa-print"></i></button>
            <button id="btnExcel" class="btn-icon btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i></button>
            <button id="btnReset" class="btn-icon btn-reset" onclick="resetHidden()"><i class="fas fa-eye"></i></button>
            
            <button id="btnAdmin" class="btn-icon" style="background:#2c3e50; display:none;" onclick="manageUsers()" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"><i class="fas fa-users-cog"></i></button>
        </div>
    </div>

    <div id="adminDashboard" class="perf-container" style="display:none; background:#f0f3f4; border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom: 0;">
        <div id="boxCost" class="stat-card" style="border-left: 5px solid #e74c3c;">
            <div class="stat-header"><i class="fas fa-box-open" style="color:#e74c3c"></i> <span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (Cost)</span></div>
            <div class="stat-body"><h1 id="txtTotalCost" class="big-number" style="color:#e74c3c; font-size:32px;">0</h1><span class="unit-text">‡∏ö‡∏≤‡∏ó</span></div>
        </div>
        <div id="boxProfit" class="stat-card" style="border-left: 5px solid #27ae60;">
            <div class="stat-header"><i class="fas fa-chart-line" style="color:#27ae60"></i> <span>‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Profit)</span></div>
            <div class="stat-body"><h1 id="txtNetProfit" class="big-number" style="color:#27ae60; font-size:32px;">0</h1><span class="unit-text">‡∏ö‡∏≤‡∏ó (‡∏Ç‡∏≤‡∏¢ - ‡∏ó‡∏∏‡∏ô)</span></div>
        </div>
    </div>

    <div class="perf-container" id="statContainer">
        <div id="cardDaily" class="stat-card">
            <div class="stat-header"><i class="fas fa-wallet" style="color:#ff6b6b"></i> <span>‡∏¢‡∏≠‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Daily)</span></div>
            <div class="stat-body"><h1 id="txtTodayCollected" class="big-number" style="color:#4361ee;">0</h1><span class="unit-text">‡∏ö‡∏≤‡∏ó</span></div>
        </div>

        <div class="stat-card">
            <div class="stat-header"><i class="fas fa-sack-dollar" style="color:#54a0ff"></i> <span>‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (Monthly)</span></div>
            <div class="stat-body"><h1 id="txtMonthCollected" class="big-number" style="color:#3f37c9;">0</h1><span class="unit-text">‡∏ö‡∏≤‡∏ó</span></div>
        </div>

        <div class="stat-card">
            <div class="stat-header"><i class="fas fa-coins" style="color:gold"></i> <span>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (20%)</span></div>
            <div class="stat-body"><h1 id="txtCommission" class="big-number" style="color:gold;">0</h1><span class="unit-text">‡∏ö‡∏≤‡∏ó (‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</span></div>
        </div>
    </div>

    <div class="list-container">
        <div id="searchResultTitle" style="display:none; margin-bottom:10px; font-weight:bold; color:var(--primary);">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: <span id="txtSearchKeyword"></span> <button onclick="clearSearch()" style="background:#ddd; border:none; padding:3px 8px; border-radius:5px; cursor:pointer; font-size:12px;">‡∏•‡πâ‡∏≤‡∏á</button></div>
        <div id="polygonContainer" class="polygon-grid"></div>
        <div id="contractListHeading" style="font-weight:bold; color:#555; margin: 15px 0 5px 0; display:none;">‚ñº ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤</div>
        <div id="contractList"></div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbw5XFnKks2y7xMlhSQQOFYIfkB5k4ijd2K-Zs72fXrN39Mrl6OsXJ2gA1ac0wqiWCQ2-w/exec'; 
        let currentUser = null;
        let currentTrackingData = [], filteredData = [], globalSummary = {};
        let contractGroups = {}; 
        let isSearchMode = false;
        const toBase64 = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
        function linkify(text) { if (!text) return ''; const urlRegex = /(https?:\/\/[^\]\s]+)/g; return text.replace(urlRegex, function(url) { let downloadUrl = url; if(url.includes('drive.google.com') && url.includes('export=view')) { downloadUrl = url.replace('export=view', 'export=download'); } return `<span style="display:inline-flex; align-items:center; gap:4px; vertical-align:middle; margin-right:5px;"><a href="${url}" target="_blank" style="text-decoration:none; background:#e3f2fd; color:#1565c0; padding:2px 6px; border-radius:4px; font-size:11px; border:1px solid #90caf9;"><i class="fas fa-eye"></i> ‡∏î‡∏π</a><a href="${downloadUrl}" target="_blank" style="text-decoration:none; background:#ffebee; color:#c62828; padding:2px 6px; border-radius:4px; font-size:11px; border:1px solid #ef9a9a;" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ"><i class="fas fa-save"></i></a></span>`; }); }

        window.onload = function() {
            const saved = localStorage.getItem('kamky_user');
            if (saved) { currentUser = JSON.parse(saved); initApp(); } 
            else { document.getElementById('filterDate').valueAsDate = new Date(); }
        };

        async function doLogin() {
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            const msg = document.getElementById('loginMsg');
            if(!u || !p) { msg.innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; return; }
            msg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            try {
                const res = await fetch(API_URL, { method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify({action:'login', username:u, password:p}) });
                const d = await res.json();
                if(d.status === 'success') {
                    currentUser = d.user;
                    localStorage.setItem('kamky_user', JSON.stringify(currentUser));
                    initApp();
                } else { msg.innerHTML = `‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`; msg.style.color = 'red'; }
            } catch(e) { msg.innerText = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'; msg.style.color = 'red'; }
        }
        function doLogout() { localStorage.removeItem('kamky_user'); location.reload(); }

        // üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å User ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏á Role)
        function checkPerm(menuCode) {
            if (!currentUser) return false;
            
            // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏°‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á)
            const userPerms = (currentUser.allowed_menus || "").toLowerCase();
            
            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô role admin ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏•‡∏≠‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πá‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô
            // (‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Admin ‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡πä‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç currentUser.role === 'admin' ‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö)
            if (currentUser.role === 'admin') return true; 
            
            return userPerms.includes(menuCode.toLowerCase());
        }

        // üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
        function initApp() {
            // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Login ‡πÅ‡∏•‡∏∞ Profile
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appTitle').innerHTML += ` <span class="user-profile-badge" onclick="userProfile()"><i class="fas fa-user"></i> ${currentUser.name}</span>`;
            document.getElementById('btnLogout').style.display = 'flex';
            if(!document.getElementById('filterDate').value) document.getElementById('filterDate').valueAsDate = new Date();

            // 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏∏‡πà‡∏° ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Permissions)
            
            // 2.1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (manage_users) -> ‡∏õ‡∏∏‡πà‡∏° Admin
            const btnAdmin = document.getElementById('btnAdmin');
            if (btnAdmin) btnAdmin.style.display = checkPerm('manage_users') ? 'flex' : 'none';

            // 2.2 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (expense) -> ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
            const btnExpense = document.getElementById('btnExpense');
            if (btnExpense) btnExpense.style.display = checkPerm('expense') ? 'flex' : 'none';

            // 2.3 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏≠‡∏ô‡∏£‡πâ‡∏≤‡∏ô (shop_report) -> ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏£‡πâ‡∏≤‡∏ô
            const btnShopReport = document.getElementById('btnShopReport');
            if (btnShopReport) btnShopReport.style.display = checkPerm('shop_report') ? 'flex' : 'none';

            // 2.4 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏¢‡∏≠‡∏î‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (closed) -> ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î/‡∏Ñ‡∏£‡∏ö‡∏á‡∏ß‡∏î
            // (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ querySelector ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ class ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ id ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤)
            const btnClosed = document.querySelector('.btn-closed');
            if (btnClosed) btnClosed.style.display = checkPerm('closed') ? 'inline-flex' : 'none';

            // 2.5 ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Excel/Reset/Print) -> ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ Admin ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 'manage_users' ‡πÄ‡∏´‡πá‡∏ô
            // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç if ‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å
            const commonTools = ['btnExcel', 'btnReset'];
            const canManage = checkPerm('manage_users'); 
            commonTools.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.style.display = canManage ? 'flex' : 'none';
            });

            // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            loadData();
        }

        async function loadData() {
            if (!currentUser) return; 
            
            const dateInput = document.getElementById('filterDate');
            if (!dateInput.value) dateInput.valueAsDate = new Date();
            const date = dateInput.value;

            document.getElementById('contractList').innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';

            try {
                const response = await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        action: 'get_tracking', 
                        date: date,
                        user: currentUser 
                    }) 
                });
                
                const data = await response.json();

                if (data.contracts) {
                    currentTrackingData = data.contracts;
                    renderDashboard(data, date);
                } else {
                    document.getElementById('contractList').innerHTML = '<div class="loading-state">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
                }

            } catch (error) {
                console.error("Load Data Error:", error);
                document.getElementById('contractList').innerHTML = '<div class="loading-state" style="color:red">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>';
            }
        }

        async function recordExpense() {
    if(!currentUser || currentUser.role !== 'admin') return Swal.fire('Access Denied', '‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'warning');
    
    const { value: formValues } = await Swal.fire({
        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Cost Center)',
        html: `
            <div style="text-align:left; margin-bottom:5px; font-weight:bold;">1. ‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô/‡∏ó‡∏µ‡∏°‡∏Ç‡∏≤‡∏¢:</div>
            <select id="exp-sale-code" class="swal2-input" style="margin:0 0 15px 0; width:100%;">
                <option value="Central">üè¢ ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Central)</option>
                <option value="T">üë§ ‡∏ó‡∏µ‡∏° T</option>
                <option value="K">üë§ ‡∏ó‡∏µ‡∏° K</option>
                <option value="N">üë§ ‡∏ó‡∏µ‡∏° N</option>
            </select>
            
            <div style="text-align:left; margin-bottom:5px; font-weight:bold;">2. ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢:</div>
            <select id="exp-type" class="swal2-input" style="margin:0 0 15px 0; width:100%;">
                <option value="‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">üì° ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</option>
                <option value="‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">üë• ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>
                <option value="‡∏Ñ‡πà‡∏≤‡∏õ‡∏•‡∏î iCloud">üîì ‡∏Ñ‡πà‡∏≤‡∏õ‡∏•‡∏î iCloud</option>
                <option value="‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô">üí∞ ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</option>
                <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">üìù ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
            </select>
            
            <div style="text-align:left; margin-bottom:5px; font-weight:bold;">3. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó):</div>
            <input id="exp-amount" type="number" class="swal2-input" style="margin:0 0 15px 0; width:100%;" placeholder="0.00">
            
            <div style="text-align:left; margin-bottom:5px; font-weight:bold;">4. ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î):</div>
            <input id="exp-note" class="swal2-input" style="margin:0 0 15px 0; width:100%;" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏¢ ‡∏Å., ‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...">
        `,
        showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        preConfirm: () => { 
            return { 
                sale_code: document.getElementById('exp-sale-code').value, // ‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Sale Code
                type: document.getElementById('exp-type').value, 
                amount: document.getElementById('exp-amount').value, 
                note: document.getElementById('exp-note').value 
            } 
        }
    });

    if (formValues) {
        if(!formValues.amount) return Swal.fire('Error', '‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'error');
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        try {
            await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ 
                    action: 'add_expense', 
                    date: new Date().toISOString().split('T')[0], 
                    sale_code: formValues.sale_code, // ‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ Sale Code ‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    type: formValues.type, 
                    amount: formValues.amount, 
                    note: formValues.note, 
                    user: currentUser.name 
                }) 
            });
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } catch (e) { Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
    }
}

        // ==========================================
        // ‚úÖ User Management
        // ==========================================
        async function manageUsers() {
            if (!currentUser || currentUser.role !== 'admin') return Swal.fire('Error', 'Access Denied', 'error');
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...', didOpen: () => Swal.showLoading() });
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get_users' }) });
                const data = await res.json();
                if (data.status !== 'success') throw new Error(data.message || 'Load failed');
                
                let html = `<div style="text-align:left; max-height:300px; overflow-y:auto;"><table style="width:100%; font-size:14px; border-collapse:collapse;"><tr style="background:#eee; text-align:left;"><th style="padding:5px;">User</th><th style="padding:5px;">Name</th><th style="padding:5px;">Role</th><th style="padding:5px;">Action</th></tr>`;
                data.users.forEach(u => {
                    html += `<tr style="border-bottom:1px solid #ddd;"><td style="padding:5px;">${u.username}</td><td style="padding:5px;">${u.name}</td><td style="padding:5px;">${u.role}</td><td style="padding:5px;">${u.username !== 'admin' ? `<button onclick="deleteUser('${u.username}')" style="background:#ff6b6b; color:white; border:none; padding:2px 8px; border-radius:4px; cursor:pointer;">‡∏•‡∏ö</button>` : '-'}</td></tr>`;
                });
                html += `</table></div>`;
                
                Swal.fire({
                    title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', html: html, width: '600px', showCloseButton: true, showConfirmButton: true, confirmButtonText: '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà', confirmButtonColor: '#27ae60'
                }).then((r) => { if (r.isConfirmed) addUser(); });

            } catch (e) {
                Swal.fire({icon:'warning', title:'‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô get_users ‡πÉ‡∏ô Script (‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ)', confirmButtonText:'+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà', showCancelButton:true}).then(r=>{ if(r.isConfirmed) addUser(); });
            }
        }

        // üü¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô addUser ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
async function addUser() {
    const { value: formValues } = await Swal.fire({
        title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
        // üëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô Checkbox ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        html: `
            <input id="new-user" class="swal2-input" placeholder="Username (‡πÑ‡∏≠‡∏î‡∏µ)" style="margin-bottom:10px;">
            <input id="new-pass" class="swal2-input" placeholder="Password (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô)" style="margin-bottom:10px;">
            <input id="new-name" class="swal2-input" placeholder="Display Name (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å)" style="margin-bottom:10px;">
            <select id="new-role" class="swal2-input" style="margin-bottom:15px;">
                <option value="user">User (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</option>
                <option value="admin">Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</option>
            </select>
            
            <div style="text-align:left; background:#f9f9f9; padding:10px; border-radius:8px; font-size:14px;">
                <div style="font-weight:bold; margin-bottom:5px; color:#555;">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Permissions):</div>
                <label style="cursor:pointer; display:block; margin-bottom:3px;">
                    <input type="checkbox" class="perm-chk" value="dashboard"> üìä ‡∏î‡∏π Dashboard (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°/‡∏Å‡∏≥‡πÑ‡∏£)
                </label>
                <label style="cursor:pointer; display:block; margin-bottom:3px;">
                    <input type="checkbox" class="perm-chk" value="expense"> üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
                </label>
                <label style="cursor:pointer; display:block; margin-bottom:3px;">
                    <input type="checkbox" class="perm-chk" value="shop_report"> üè™ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏≠‡∏ô‡∏£‡πâ‡∏≤‡∏ô
                </label>
                <label style="cursor:pointer; display:block; margin-bottom:3px;">
                    <input type="checkbox" class="perm-chk" value="closed"> ‚úÖ ‡∏î‡∏π‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î/‡∏Ñ‡∏£‡∏ö‡∏á‡∏ß‡∏î
                </label>
                 <label style="cursor:pointer; display:block;">
                    <input type="checkbox" class="perm-chk" value="manage_users"> üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Admin)
                </label>
            </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
        confirmButtonColor: '#27ae60',
        preConfirm: () => {
            // üëá ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Checkbox ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡πä‡∏Å‡πÑ‡∏ß‡πâ
            const checkboxes = document.querySelectorAll('.perm-chk:checked');
            const selectedMenus = Array.from(checkboxes).map(cb => cb.value).join(',');

            return { 
                username: document.getElementById('new-user').value, 
                password: document.getElementById('new-pass').value, 
                name: document.getElementById('new-name').value, 
                role: document.getElementById('new-role').value,
                allowed_menus: selectedMenus // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
            } 
        }
    });

    if (formValues) {
        if(!formValues.username || !formValues.password) return Swal.fire('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
        
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
        
        try {
            // ‡∏™‡πà‡∏á action: 'add_user' ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Apps Script
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add_user', ...formValues }) });
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => manageUsers());
        } catch(e) { 
            Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); 
        }
    }
}

        async function deleteUser(username) {
            Swal.fire({ title: `‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${username}?`, text: "‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö' }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', didOpen: () => Swal.showLoading() });
                    try {
                        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete_user', username: username }) });
                        Swal.fire('Deleted!', '', 'success').then(() => manageUsers());
                    } catch(e) { Swal.fire('Error', '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
                }
            });
        }
        // ==========================================

        async function doGlobalSearch() {
            const keyword = document.getElementById('searchInput').value.trim();
            if(!keyword) return;
            isSearchMode = true;
            document.getElementById('statContainer').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('polygonContainer').style.display = 'none';
            document.getElementById('searchResultTitle').style.display = 'block';
            document.getElementById('txtSearchKeyword').innerText = keyword;
            const container = document.getElementById('contractList');
            container.innerHTML = '<div class="loading-state">üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'search_tracking', keyword: keyword }) });
                const data = await response.json();
                if(data.contracts) {
                    filteredData = data.contracts.map(c => { let amt = parseFloat(c.amount || 0) * (c.overdue_count > 1 ? c.overdue_count : 1); return { ...c, finalAmount: amt, hasPostpone: (c.postpone_date && c.postpone_date !== "-") }; });
                } else { filteredData = []; }
                renderDirectList(data.contracts);
            } catch (e) { container.innerHTML = '<div class="loading-state" style="color:red">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>'; }
        }

        function clearSearch() { document.getElementById('searchInput').value = ''; clearSearchUI(); loadData(); }
        function clearSearchUI() { isSearchMode = false; document.getElementById('statContainer').style.display = 'grid'; document.getElementById('polygonContainer').style.display = 'grid'; document.getElementById('searchResultTitle').style.display = 'none'; document.getElementById('contractListHeading').style.display = 'none'; }
        
        function showClosedContracts() {
            if(!currentTrackingData || currentTrackingData.length === 0) { alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...'); return; }
            const closedList = currentTrackingData.filter(c => c.status === 'Paid' || c.status === 'Close');
            filteredData = closedList.map(c => { let amt = parseFloat(c.amount || 0); return { ...c, finalAmount: amt, hasPostpone: false }; });
            isSearchMode = true;
            document.getElementById('statContainer').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('polygonContainer').style.display = 'none';
            document.getElementById('searchResultTitle').style.display = 'block';
            document.getElementById('txtSearchKeyword').innerText = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡∏Ñ‡∏£‡∏ö‡∏á‡∏ß‡∏î (${closedList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
            renderDirectList(closedList);
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)
        function showAllContracts() {
            if(!currentTrackingData || currentTrackingData.length === 0) { alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'); return; }
            
            isSearchMode = true;
            document.getElementById('statContainer').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('polygonContainer').style.display = 'none';
            document.getElementById('searchResultTitle').style.display = 'block';
            document.getElementById('contractListHeading').style.display = 'none';
            document.getElementById('txtSearchKeyword').innerText = `‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${currentTrackingData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) - ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞`;

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏õ‡∏Å‡∏ï‡∏¥ -> ‡∏Ñ‡πâ‡∏≤‡∏á -> ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î -> ‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏µ‡∏¢
            let sortedData = [...currentTrackingData].sort((a, b) => {
                const getPriority = (c) => {
                    const isClosed = (c.status === 'Paid' || c.status === 'Close');
                    const isBadDebt = (c.overdue_count >= 3); 
                    
                    if (isBadDebt) return 4;
                    if (isClosed) return 3;
                    if (c.overdue_count > 0) return 2;
                    return 1; // Normal
                };
                return getPriority(a) - getPriority(b);
            });

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
            filteredData = sortedData.map(c => {
                let amt = parseFloat(c.amount || 0) * (c.overdue_count > 1 ? c.overdue_count : 1);
                let statusSuffix = "";
                
                if (c.overdue_count >= 3) statusSuffix = " (‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏µ‡∏¢)";
                else if (c.status === 'Paid' || c.status === 'Close') statusSuffix = " (‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î)";
                else if (c.overdue_count > 0) statusSuffix = ` (‡∏Ñ‡πâ‡∏≤‡∏á ${c.overdue_count})`;
                else statusSuffix = " (‡∏õ‡∏Å‡∏ï‡∏¥)";

                return { 
                    ...c, 
                    b_name: `${c.b_name} <span style="font-size:12px; font-weight:bold; color:${statusSuffix.includes('‡∏õ‡∏Å‡∏ï‡∏¥')?'green':(statusSuffix.includes('‡∏õ‡∏¥‡∏î')?'blue':'red')}">${statusSuffix}</span>`,
                    finalAmount: amt, 
                    hasPostpone: (c.postpone_date && c.postpone_date !== "-" && c.postpone_date !== "") 
                };
            });

            renderDirectList(filteredData);
        }

        function renderDashboard(data, selectedDate, forceShowAll) {
            const container = document.getElementById('contractList'); 
            const polyContainer = document.getElementById('polygonContainer');
            globalSummary = data.summary || {};
            container.innerHTML = ""; polyContainer.innerHTML = "";
            document.getElementById('contractListHeading').style.display = 'none';
            filteredData = [];
            const hidden = JSON.parse(localStorage.getItem('hiddenContracts') || '[]').map(String);
            const selectedDateThai = selectedDate ? formatDateToThai(selectedDate) : "";
            let selectedYearTH = ""; let selectedMonthOnly = "";
            if(selectedDate) { let d = new Date(selectedDate); selectedYearTH = d.getFullYear() + 543; selectedMonthOnly = ("0" + (d.getMonth() + 1)).slice(-2); }
            const selectedMonthStr = `${selectedYearTH}-${selectedMonthOnly}`; 
            contractGroups = { pending: [], normal: [], postpone: [], overdue: [] };
            let strictDailyCollected = 0; let strictMonthlyCollected = 0;
            
            // =========================================================
            // üü¢ ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô (Visibility Control)
            // =========================================================
            const dashboard = document.getElementById('adminDashboard');
            const boxCost = document.getElementById('boxCost');     // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (Dashboard ‡∏ö‡∏ô)
            const cardDaily = document.getElementById('cardDaily'); // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Dashboard ‡∏•‡πà‡∏≤‡∏á)

            // ‡πÄ‡∏õ‡∏¥‡∏î Dashboard ‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
            dashboard.style.display = 'grid'; 

            if (currentUser && currentUser.role === 'admin') {
                // --- ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô ADMIN ---
                // 1. ‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô + ‡∏õ‡∏£‡∏±‡∏ö Grid ‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                boxCost.style.display = 'block';
                dashboard.style.gridTemplateColumns = '1fr 1fr';
                
                // 2. ‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                if(cardDaily) cardDaily.style.display = 'block';
            } else {
                // --- ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô USER ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ---
                // 1. ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô + ‡∏õ‡∏£‡∏±‡∏ö Grid ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠)
                boxCost.style.display = 'none';
                dashboard.style.gridTemplateColumns = '1fr';
                
                // 2. ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                if(cardDaily) cardDaily.style.display = 'none';
            }
            // =========================================================

            if (data.contracts) {
                data.contracts.forEach(c => {
                    const amount = parseFloat(c.amount || 0);
                    const isPaid = ['Paid', 'Close', '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î'].includes(c.status);
                    const isPostponedToToday = (c.postpone_date === selectedDateThai);
                    const isDueToday = (c.due_date === selectedDateThai);
                    const hasPostpone = (c.postpone_date && c.postpone_date !== "-" && c.postpone_date !== "");
                    const isPendingStatus = ['Pending_Approve', '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î'].includes(c.status);
                    let isTargetToday = (isPostponedToToday) || (isDueToday && !hasPostpone);
                    
                    if (isTargetToday && isPaid) strictDailyCollected += amount;
                    if (c.due_date) { const parts = c.due_date.split('/'); if(parts.length === 3) { const cMonthStr = `${parts[2]}-${parts[1]}`; if (cMonthStr === selectedMonthStr && isPaid) strictMonthlyCollected += amount; } }
                    
                    if (hidden.includes(String(c.c_no))) return;
                    if (isPaid) return; 

                    let amt = parseFloat(c.amount) * (c.overdue_count > 1 ? c.overdue_count : 1);
                    if (c.original_due_date !== selectedDateThai && c.postpone_date === selectedDateThai) { c.worksheetStatus = `‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å ${c.original_due_date}`; } else { if (isPendingStatus) { c.worksheetStatus = c.status === '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î' ? '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î' : '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; } else { c.worksheetStatus = c.overdue_count > 0 ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : '‡∏õ‡∏Å‡∏ï‡∏¥'; } }
                    let item = { ...c, finalAmount: amt, hasPostpone: hasPostpone };
                    filteredData.push(item);
                    
                    if (isPendingStatus) { 
                        if (currentUser.role === 'admin' || !isPendingStatus) contractGroups.pending.push(item); 
                    } 
                    else if (isPostponedToToday) { contractGroups.postpone.push(item); }
                    else if (c.overdue_count > 0) { contractGroups.overdue.push(item); } 
                    else if (isTargetToday) { contractGroups.normal.push(item); }
                });
            }
            
            updateCharts(0, strictDailyCollected, 0, strictMonthlyCollected);

            if (data.summary && data.summary.commission !== undefined) {
                 const commEl = document.getElementById('txtCommission');
                 if(commEl) commEl.innerText = (data.summary.commission || 0).toLocaleString(); 
            }

            if (contractGroups.pending.length > 0 && currentUser.role === 'admin') { 
                polyContainer.innerHTML += createPolygonHtml('pending', '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', contractGroups.pending.length, 'poly-bg-pending', 'fas fa-clock'); 
            }
            
            polyContainer.innerHTML += createPolygonHtml('normal', '‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)', contractGroups.normal.length, 'poly-bg-normal', 'fas fa-calendar-check');
            polyContainer.innerHTML += createPolygonHtml('postpone', '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏°‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', contractGroups.postpone.length, 'poly-bg-postpone', 'fas fa-history');
            polyContainer.innerHTML += createPolygonHtml('overdue', '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î', contractGroups.overdue.length, 'poly-bg-overdue', 'fas fa-exclamation-circle');
            container.innerHTML = `<div class="loading-state" style="padding:20px;">üëà ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
        }

        function createPolygonHtml(groupKey, title, count, bgClass, iconClass) {
            return `<div class="polygon-card ${bgClass}" onclick="showGroupList('${groupKey}', '${title}')"><i class="${iconClass} poly-icon"></i><div class="poly-count">${count}</div><div class="poly-title">${title}</div></div>`;
        }

        function showGroupList(groupKey, title) {
            const list = contractGroups[groupKey];
            const container = document.getElementById('contractList');
            const heading = document.getElementById('contractListHeading');
            heading.style.display = 'block';
            heading.innerText = `‚ñº ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${title} (${list.length})`;
            renderDirectList(list);
            setTimeout(() => { heading.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
        }

        function renderDirectList(items) {
            const container = document.getElementById('contractList');
            if (!items || items.length === 0) { container.innerHTML = '<div class="loading-state">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>'; return; }
            container.innerHTML = items.map(c => createCardHtml(c)).join('');
        }

        function createCardHtml(c) {
    if (c.finalAmount === undefined) { c.finalAmount = parseFloat(c.amount || 0) * (c.overdue_count > 1 ? c.overdue_count : 1); }
    if (c.hasPostpone === undefined) { c.hasPostpone = (c.postpone_date && c.postpone_date !== "-" && c.postpone_date !== ""); }
    const isAdmin = currentUser.role === 'admin'; // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Edit/Delete) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    
    let cardClass = isSearchMode ? "card-search-result" : "card-normal"; 
    let statusHtml = `<span class="status-text text-green"><i class="fas fa-check-circle"></i> ‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
    let hasPaymentNote = c.last_note && c.last_note.includes('‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞');
    const isClosed = (c.status === 'Paid' || c.status === 'Close');

    // Logic ‡∏™‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    if (c.status === 'Pending_Approve' || c.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') { 
        cardClass = "card-pending-approve"; 
        if(isAdmin) statusHtml = `<span class="status-text text-orange" onclick="adminApprove('${c.c_no}', ${c.row_index}, '${c.request_date}', '${c.last_note || ''}', 'postpone')">‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏Å‡∏î)</span>`; 
        else statusHtml = `<span class="status-text text-orange">‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>`; 
    } 
    else if (c.status === '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î') { 
        cardClass = "card-pending-approve"; 
        if(isAdmin) statusHtml = `<span class="status-text text-red" style="cursor:pointer;" onclick="adminApprove('${c.c_no}', ${c.row_index}, '-', '${c.last_note || ''}', 'close')">üèÅ ‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î (‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</span>`; 
        else statusHtml = `<span class="status-text text-red">üèÅ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</span>`; 
    }
    else if (c.hasPostpone) { cardClass = "card-postpone"; statusHtml = `<span class="status-text text-purple">‚è∞ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô: ${c.postpone_date}</span>`; } 
    else if (c.overdue_count > 0) { cardClass = "card-overdue"; statusHtml = `<span class="status-text text-red">‚ùó ‡∏Ñ‡πâ‡∏≤‡∏á ${c.overdue_count} ‡∏á‡∏ß‡∏î</span>`; }
    else if (isClosed) { statusHtml = `<span class="status-text text-green">‚úÖ ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß (${c.last_payment_date})</span>`; }

    if (hasPaymentNote) { let noteContent = linkify(c.last_note); statusHtml += `<div style="font-size:11px; color:#4361ee; background:#eef2ff; padding:6px; border-radius:4px; margin-top:4px; border:1px solid #dce6ff; white-space:normal; word-break:break-all;">üí∞ ${noteContent}</div>`; }

    // üü¢ ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ROI / ‡∏Å‡∏≥‡πÑ‡∏£ (‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô)
    let financialHtml = '';
    // ‚úÖ ‡πÄ‡∏≠‡∏≤ if (isAdmin) ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ
    let profitClass = c.current_profit >= 0 ? 'color:#27ae60;' : 'color:#c0392b;';
    let profitIcon = c.current_profit >= 0 ? 'üìà ‡∏Å‡∏≥‡πÑ‡∏£' : 'üìâ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô';
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á Progress Bar
    let progressPercent = 0;
    if (c.product_cost > 0) {
        progressPercent = (c.total_revenue / c.product_cost) * 100;
    } else {
        progressPercent = 100; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    }
    if (progressPercent > 100) progressPercent = 100;

    financialHtml = `
        <div style="background:#f8f9fa; padding:8px; margin-top:10px; border-radius:8px; font-size:12px; border:1px solid #eee;">
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                <span style="color:#7f8c8d;">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô: ${parseInt(c.product_cost || 0).toLocaleString()}</span>
                <span style="font-weight:bold; ${profitClass}">${profitIcon} ${parseInt(c.current_profit || 0).toLocaleString()}</span>
            </div>
            <div style="width:100%; background:#e0e0e0; height:6px; border-radius:3px; overflow:hidden;">
                <div style="width:${progressPercent}%; background:${c.current_profit >= 0 ? '#27ae60' : '#f39c12'}; height:100%;"></div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:10px; color:#95a5a6; margin-top:2px;">
                <span>‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á: ${parseInt(c.total_revenue || 0).toLocaleString()}</span>
                <span>ROI: ${c.roi_percent || 0}%</span>
            </div>
        </div>
    `;

    // ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÅ‡∏¢‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin/User ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô User ‡πÑ‡∏õ‡∏Å‡∏î‡∏•‡∏ö‡∏°‡∏±‡πà‡∏ß)
    let menuButton = isAdmin ? `<button class="btn-kebab" style="margin-left:5px;" onclick="openManageMenu(${c.row_index},'${c.b_name}','${c.c_no}')">‚ãÆ</button>` : '';
    let actionButtonsHtml = '', gridClass = '';
    const hasExtraInfo = (c.contact_image && c.contact_image !== "" && c.contact_image !== "-");
    const infoBtn = hasExtraInfo ? `<button class="btn-act btn-act-info" onclick="openContactImage('${c.c_no}')"><i class="fas fa-address-card"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>` : `<button class="btn-act btn-disabled" disabled><i class="fas fa-address-card"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>`;
    const contractBtn = `<button class="btn-act btn-act-contract" onclick="openContractPopup('${c.c_no}')"><i class="fas fa-file-contract"></i> ‡∏™‡∏±‡∏ç‡∏ç‡∏≤</button>`;

    if (isClosed) {
        gridClass = 'grid-closed-actions';
        actionButtonsHtml = `${infoBtn}${contractBtn}`;
    } else {
        if (isAdmin) {
            gridClass = 'grid-admin-actions';
            actionButtonsHtml = `<a href="tel:${c.b_mobile}" class="btn-act btn-act-call"><i class="fas fa-phone"></i> ‡πÇ‡∏ó‡∏£</a>${infoBtn}${contractBtn}<button class="btn-act btn-act-pay" onclick="openPay('${c.c_no}')"><i class="fas fa-wallet"></i> ‡∏à‡πà‡∏≤‡∏¢</button><button class="btn-act btn-act-postpone" style="grid-column: 1 / -1;" onclick="openPostpone(${c.row_index},'${c.b_name}', '${c.postpone_date||''}')"><i class="fas fa-calendar-check"></i> ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>`;
        } else {
            gridClass = 'grid-user-actions';
            const isPending = (c.status === 'Pending_Approve' || c.status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' || c.status === '‡∏£‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î');
            const payBtn = isPending ? `<button class="user-checkbox-btn btn-disabled" disabled><i class="fas fa-clock"></i> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>` : `<button class="user-checkbox-btn" onclick="userReqPay('${c.c_no}')"><i class="far fa-check-square"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞</button>`;
            const closeBtn = isPending ? `<button class="user-checkbox-btn btn-disabled" disabled><i class="fas fa-flag-checkered"></i> ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</button>` : `<button class="user-checkbox-btn" onclick="userReqClose('${c.c_no}')" style="color:#c0392b;"><i class="fas fa-flag-checkered"></i> ‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</button>`;
            actionButtonsHtml = `<a href="tel:${c.b_mobile}" class="btn-act btn-act-call"><i class="fas fa-phone"></i> ‡πÇ‡∏ó‡∏£</a>${infoBtn}${contractBtn}${payBtn}<button class="user-checkbox-btn" onclick="userReqPostpone('${c.c_no}')"><i class="far fa-clock"></i> ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î</button>${closeBtn}<button class="user-checkbox-btn" style="grid-column: 1 / -1;" onclick="userAddNote('${c.c_no}')"><i class="fas fa-pen"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</button>`;
        }
    }
    
    return `<div class="cust-card ${cardClass}"><div class="cust-header"><div class="cust-info"><h3>${c.b_name}</h3><span class="cust-id">#${c.c_no}</span></div><div class="status-badge">${statusHtml}</div>${menuButton}</div><div class="cust-body"><div><div class="contact-line"><i class="fas fa-phone"></i> ${c.b_mobile}</div><div class="contact-line">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${c.installment_no}</div></div><div style="text-align:right"><span style="font-size:10px; color:#777;">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span><div class="amount-val">‡∏ø${c.finalAmount.toLocaleString()}</div></div></div> ${financialHtml} <div class="cust-actions ${gridClass}">${actionButtonsHtml}</div></div>`;
}

        async function userReqPay(cNo) {
            const { value: formValues } = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
                html: `<div style="text-align:left; font-size:14px; margin-bottom:5px;">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</div><input type="file" id="swal-input-file" class="swal2-input" accept="image/*" multiple style="width:80%; margin:0 auto; display:block;"><input type="text" id="swal-input-note" class="swal2-input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" style="margin-top:10px;">`,
                icon: 'info', showCancelButton: true, confirmButtonText: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', confirmButtonColor: '#27ae60',
                preConfirm: () => { return { files: document.getElementById('swal-input-file').files, note: document.getElementById('swal-input-note').value }; }
            });
            if (formValues) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                try {
                    let slips = [];
                    if (formValues.files.length > 0) { for(let i=0; i<formValues.files.length; i++){ const file = formValues.files[i]; const base64Str = await toBase64(file); slips.push({ image: base64Str, name: `slip_${cNo}_${new Date().getTime()}_${i}.jpg`, mime: file.type }); } }
                    await sendUserRequest('request_pay', cNo, { note: '‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô: ' + (formValues.note || '-'), slips: slips });
                } catch (error) { Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå', 'error'); }
            }
        }

        async function userReqClose(cNo) {
            const { value: formValues } = await Swal.fire({
                title: '‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
                html: `<p style="font-size:14px; color:#c0392b; margin-bottom:10px;">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${cNo}</p><div style="text-align:left; font-size:14px; margin-bottom:5px;">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏¢‡∏≠‡∏î‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô):</div><input type="file" id="swal-input-file-close" class="swal2-input" accept="image/*" style="width:80%; margin:0 auto; display:block;"><input type="text" id="swal-input-note-close" class="swal2-input" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" style="margin-top:10px;">`,
                icon: 'warning', showCancelButton: true, confirmButtonText: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', confirmButtonColor: '#e74c3c',
                preConfirm: () => { const f = document.getElementById('swal-input-file-close'); if (f.files.length === 0) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î'); return false; } return { file: f.files[0], note: document.getElementById('swal-input-note-close').value }; }
            });
            if (formValues) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                try {
                    const base64Str = await toBase64(formValues.file);
                    await sendUserRequest('request_close', cNo, { note: '‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ' + (formValues.note || '-'), slip_image: base64Str, slip_name: `close_${cNo}_${new Date().getTime()}.jpg`, slip_mime: formValues.file.type });
                } catch (e) { Swal.fire('Error', '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
            }
        }

        async function userReqPostpone(cNo) { Swal.fire({title:'‡∏Ç‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏î', input:'date'}).then(r=>{if(r.value) sendUserRequest('request_postpone', cNo, {new_date:r.value});}); }
        async function userAddNote(cNo) { Swal.fire({input:'text', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}).then(r=>{if(r.value) sendUserRequest('add_daily_note', cNo, {note:r.value});}); }
        async function sendUserRequest(act, cNo, pl) { Swal.showLoading(); try { await fetch(API_URL, { method:'POST', body:JSON.stringify({ action:'user_action_log', sub_action:act, c_no:cNo, user:currentUser.username, ...pl }) }); Swal.fire({icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer:1500, showConfirmButton:false}); loadData(); } catch(e) { Swal.fire('Error', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error'); } }

        async function adminApprove(cNo, rowIndex, reqDate, details, type) {
            let title = type === 'close' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (Close)' : '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            let confirmBtn = type === 'close' ? 'üèÅ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î' : '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            let actionType = type === 'close' ? 'close_account' : 'approve_contract'; 
            Swal.fire({ title: title, html: `<p>‡∏™‡∏±‡∏ç‡∏ç‡∏≤ #${cNo}</p><h2 style="color:#4361ee;">${reqDate !== '-' ? reqDate : ''}</h2><p>${details}</p>`, icon: 'question', showCancelButton: true, showDenyButton: true, denyButtonText: '‚ùå ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö (‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)', confirmButtonText: confirmBtn, cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' 
            }).then(async (result) => { 
                if (result.isConfirmed) { 
                    Swal.showLoading(); 
                    if (type === 'postpone' && reqDate && reqDate !== '-') { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'postpone', row_index: rowIndex, new_date: reqDate }) }); } 
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: actionType, row_index: rowIndex }) }); 
                    Swal.fire({ title: '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", icon: 'success', showCancelButton: true, confirmButtonText: 'üñ®Ô∏è ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', cancelButtonText: '‡∏õ‡∏¥‡∏î', confirmButtonColor: '#2c3e50' }).then((r) => { if (r.isConfirmed) { window.open(`https://kamkywork.github.io/kamkybill-app/?ref=${encodeURIComponent(cNo)}`, '_blank'); } loadData(); });
                } else if (result.isDenied) {
                    const { value: reason } = await Swal.fire({ title: '‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö', input: 'text', inputPlaceholder: '‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î, ‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á', showCancelButton: true });
                    if (reason) { Swal.showLoading(); await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'reject_request', row_index: rowIndex, reason: reason }) }); Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success').then(() => loadData()); }
                }
            });
        }

        function openPostpone(idx, name, currentVal) { Swal.fire({ title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢', html: `<div style="margin-bottom:10px;">‡πÄ‡∏î‡∏¥‡∏°: <b>${currentVal || '-'}</b></div><input type="date" id="swal-date" class="swal2-input">`, showDenyButton: true, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', denyButtonText: '‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢', cancelButtonText: '‡∏õ‡∏¥‡∏î' }).then(r => { if (r.isConfirmed) executeAction({ action: 'postpone', row_index: idx, new_date: document.getElementById('swal-date').value }); else if (r.isDenied) executeAction({ action: 'postpone', row_index: idx, new_date: '' }); }); }
        
        async function openContractPopup(cNo) { Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', allowOutsideClick: false, didOpen: () => Swal.showLoading() }); try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get_contract_image', c_no: String(cNo) }) }); const d = await res.json(); if(d.status === 'success') { let fileId = ""; if(d.url.includes("id=")) { fileId = d.url.split('id=')[1].split('&')[0]; } if(fileId) { let previewUrl = `https://drive.google.com/file/d/${fileId}/preview`; Swal.fire({ html: `<div style="position:relative; padding-bottom:10px;"><iframe src="${previewUrl}" width="100%" height="450px" style="border:none; border-radius:8px;"></iframe></div>`, width: '600px', showCloseButton: true, confirmButtonText: '‡∏õ‡∏¥‡∏î', footer: `<a href="${d.url}" target="_blank" style="color:#4361ee; font-weight:bold; text-decoration:underline;">‡∏´‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ Drive</a>` }); } else { Swal.fire({ imageUrl: d.url, width: '95%', confirmButtonText: '‡∏õ‡∏¥‡∏î' }); } } else { Swal.fire({ icon: 'warning', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏™‡∏±‡∏ç‡∏ç‡∏≤' }); } } catch(e) { Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î' }); } }
        async function openContactImage(cNo) { Swal.showLoading(); try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get_contract_image', c_no: cNo, type: 'contact_aw' }) }); const d = await res.json(); if(d.status==='success') { let fileId = ""; if(d.url.includes("id=")) { fileId = d.url.split('id=')[1].split('&')[0]; } if(fileId) { let previewUrl = `https://drive.google.com/file/d/${fileId}/preview`; Swal.fire({ html: `<iframe src="${previewUrl}" width="100%" height="450px" style="border:none; border-radius:8px;"></iframe>`, width: '600px', showCloseButton: true, confirmButtonText: '‡∏õ‡∏¥‡∏î' }); } else { Swal.fire({ imageUrl: d.url, width: '95%', confirmButtonText: '‡∏õ‡∏¥‡∏î' }); } } else Swal.fire({ icon: 'warning', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (AW)' }); } catch(e) { Swal.fire('Error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); } }
        function formatDateToThai(dateString) { if(!dateString) return ""; const p = dateString.split('-'); let year = parseInt(p[0]) + 543; return `${p[2]}/${p[1]}/${year}`; }
        function updateCharts(dailyTarget, dailyCollected, monthlyTarget, monthlyCollected) { 
            // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
            document.getElementById('txtTodayCollected').innerText = dailyCollected.toLocaleString(); 
            document.getElementById('txtMonthCollected').innerText = monthlyCollected.toLocaleString();
            
            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ)
            if (globalSummary) {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (Total Cost)
                if (document.getElementById('txtTotalCost')) {
                    let cost = globalSummary.total_cost || 0;
                    document.getElementById('txtTotalCost').innerText = cost.toLocaleString();
                }

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Profit)
                if (document.getElementById('txtNetProfit')) {
                    let profit = globalSummary.net_profit || 0; 
                    let profitEl = document.getElementById('txtNetProfit');
                    
                    profitEl.innerText = profit.toLocaleString();

                    // üü¢ Logic ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ: ‡∏ï‡∏¥‡∏î‡∏•‡∏ö=‡πÅ‡∏î‡∏á, ‡∏ö‡∏ß‡∏Å=‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    if (profit < 0) {
                        profitEl.style.color = "#e74c3c"; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                    } else {
                        profitEl.style.color = "#27ae60"; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    }
                }
            }

            // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏û‡∏µ‡∏¢‡∏ß‡πÜ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡πâ‡∏ß)
            if (globalSummary && globalSummary.commission !== undefined) {
                 const commEl = document.getElementById('txtCommission');
                 if(commEl) {
                     commEl.innerText = (globalSummary.commission || 0).toLocaleString();
                     
                     // üü¢ ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á Breakdown (Detail Box) ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
                     const oldDetail = document.getElementById('commDetailBox');
                     if(oldDetail) oldDetail.remove(); 
                 }
            }
        }
        function exportToExcel() { if (!filteredData.length) return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô', 'warning'); let csv = "data:text/csv;charset=utf-8,\uFEFF‡∏•‡∏≥‡∏î‡∏±‡∏ö,‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤,‡∏ä‡∏∑‡πà‡∏≠,‡πÄ‡∏ö‡∏≠‡∏£‡πå,‡∏á‡∏ß‡∏î,‡∏¢‡∏≠‡∏î,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n"; filteredData.forEach((i, idx) => csv += `${idx+1},"${i.c_no}","${i.b_name}","${i.b_mobile}",${i.installment_no},${i.finalAmount},"${i.status}"\n`); const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "Report.csv"; link.click(); }
        function openPay(c_no) { window.open(`https://kamkywork.github.io/sale_bill/?ref=${c_no}`, '_blank'); }
        async function openManageMenu(idx, name, c_no) { const { value: action } = await Swal.fire({ title: name, input: 'select', inputOptions: { 'cancel_contract': '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤', 'close_account': '‚úÖ ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î' }, showCancelButton: true }); if(action){ Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?',showCancelButton:true}).then(r=>{if(r.isConfirmed) executeAction({action,c_no,row_index:idx})}); } }
        async function executeAction(p) { Swal.fire({ title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() }); try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(p) }); Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false }); loadData(); } catch (e) { Swal.fire('Error', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); } }
        function userProfile() { Swal.fire({ title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', html: `<b>${currentUser.name}</b><br>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${currentUser.role}`, showDenyButton: true, confirmButtonText: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', denyButtonText: '‡∏õ‡∏¥‡∏î' }).then(r => { if(r.isConfirmed) changePass(); }); }
        async function changePass() { const { value: p } = await Swal.fire({ title: '‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà', input: 'password' }); if(p) { await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'change_password', username:currentUser.username, new_pass:p}) }); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } }

        function printReport() {
            if (!filteredData || filteredData.length === 0) { Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå', 'warning'); return; }
            const now = new Date(); const dateStr = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()+543}`; const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            let tableRows = filteredData.map((item, index) => { let statusColor = item.overdue_count > 0 ? 'color:red;' : 'color:green;'; let statusText = item.status; if(item.overdue_count > 0) statusText = `‡∏Ñ‡πâ‡∏≤‡∏á ${item.overdue_count} ‡∏á‡∏ß‡∏î`; else if(item.status === 'Paid' || item.status === 'Close') statusText = '‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡πâ‡∏ß'; else if(item.status === 'Pending_Approve') statusText = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; return `<tr><td style="text-align:center;">${index + 1}</td><td>${item.c_no}</td><td>${item.b_name} <br> <span style="font-size:10px; color:#666;">${item.b_mobile}</span></td><td style="text-align:right;">${item.finalAmount.toLocaleString()}</td><td style="text-align:center; ${statusColor}">${statusText}</td><td>${item.last_note || '-'}</td></tr>`; }).join('');
            const htmlContent = `<html><head><title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ</title><link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet"><style> body { font-family: 'Sarabun', sans-serif; padding: 20px; } h2 { text-align: center; margin-bottom: 5px; } .meta { text-align: center; font-size: 12px; color: #555; margin-bottom: 20px; } table { width: 100%; border-collapse: collapse; font-size: 12px; } th { background: #eee; padding: 6px; border: 1px solid #ccc; } td { padding: 6px; border: 1px solid #ccc; vertical-align: middle; } @media print { button { display: none; } } </style></head><body><h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ</h2><div class="meta">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤ ${timeStr} | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${filteredData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div><table><thead><tr><th width="5%">#</th><th width="15%">‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th><th width="25%">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th width="15%">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</th><th width="15%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th width="25%">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody>${tableRows}</tbody></table><script>window.onload = function() { window.print(); }<\/script></body></html>`;
            let win = window.open('', '_blank'); win.document.write(htmlContent); win.document.close();
        }
		
		function showShopTransferReport() {
    // 1. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å" (‡∏ï‡∏≤‡∏° filterDate)
    const selectedDate = document.getElementById('filterDate').value; // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 01/02/69) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö c_date ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÉ‡∏ô Google Sheet ‡πÄ‡∏Å‡πá‡∏ö c_date ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô (‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ä‡πâ formatDateToThai)
    // ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≤‡∏Å ISO Date ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà c_date (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤) ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    // ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    const dailyContracts = currentTrackingData.filter(c => {
        // ‡πÅ‡∏õ‡∏•‡∏á c_date ‡∏à‡∏≤‡∏Å‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö selectedDate ‡πÑ‡∏î‡πâ
        // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ c_date_iso (YYYY-MM-DD) ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÑ‡∏ó‡∏¢
        // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ field ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö iso ‡∏à‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á (create_date) ‡∏´‡∏£‡∏∑‡∏≠ c_date ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö formatDateToThai(selectedDate)
        
        let targetDateThai = formatDateToThai(selectedDate); // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢ 1/2/69
        return c.c_date === targetDateThai; 
    });

    if (dailyContracts.length === 0) {
        Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDateToThai(selectedDate)}`, 'info');
        return;
    }

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á HTML
    let totalTransfer = 0;
    let tableRows = dailyContracts.map((c, index) => {
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ backend ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ä‡∏∑‡πà‡∏≠ shop_transfer_amount)
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ (product_cost - p_down) ‡πÅ‡∏ï‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏á‡πÜ ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤
        let transferAmt = parseFloat(String(c.shop_transfer_amount || 0).replace(/,/g,''));
        totalTransfer += transferAmt;

        return `
            <tr style="border-bottom:1px solid #ddd;">
                <td style="padding:8px;">${index + 1}</td>
                <td style="padding:8px; font-weight:bold;">${c.shop_name || '-'}</td>
                <td style="padding:8px; font-size:12px;">
                    ${c.shop_bank || '-'} <br>
                    <span style="color:#666;">(‡∏™‡∏±‡∏ç‡∏ç‡∏≤: ${c.c_no})</span>
                </td>
                <td style="padding:8px; text-align:right; font-weight:bold; color:#c0392b;">
                    ${transferAmt.toLocaleString()}
                </td>
            </tr>
        `;
    }).join('');

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ SweetAlert
    Swal.fire({
        title: `‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤`,
        html: `
            <div style="text-align:center; margin-bottom:10px; color:#555;">
                ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatDateToThai(selectedDate)}
            </div>
            <div style="max-height:300px; overflow-y:auto; border:1px solid #eee;">
                <table style="width:100%; border-collapse:collapse; font-size:14px; text-align:left;">
                    <thead style="background:#2c3e50; color:white;">
                        <tr>
                            <th style="padding:8px;">#</th>
                            <th style="padding:8px;">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th style="padding:8px;">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                            <th style="padding:8px; text-align:right;">‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                    <tfoot style="background:#f9f9f9; font-weight:bold;">
                        <tr>
                            <td colspan="3" style="padding:10px; text-align:right;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</td>
                            <td style="padding:10px; text-align:right; color:#c0392b; font-size:16px;">
                                ${totalTransfer.toLocaleString()}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        `,
        width: '600px',
        confirmButtonText: '‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á',
        showCloseButton: true,
        footer: '<button onclick="printShopReport()" style="border:none; background:none; color:blue; cursor:pointer; text-decoration:underline;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>'
    });
}
    </script>
</body>
</html>